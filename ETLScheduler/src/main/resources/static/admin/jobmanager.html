<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>JOB调度配置管理</title>
<link rel="stylesheet" href="/static/layui/css/layui.css"></link>
<link rel="stylesheet" href="/static/css/global.css"></link>


</head>
<body>

<script type="text/html" id="enabledSwitchTpl">
{{#  if(d.enabled == true){ }}
    <a title="启用" id="job_edit_btn" href="javascript:;"><i class="layui-icon">&#xe605;</i></a>
  {{#  } else { }}
   <a title="停止" id="job_edit_btn" href="javascript:;"><i class="layui-icon">&#x1006;</i></a>
  {{#  } }}

</script>
<script type="text/html" id="styleSwitchTpl">

{{#  if(d.extractStyle == 0){ }}
   <span class="layui-badge layui-bg-green">全量</span>
  {{#  } else { }}
   <span class="layui-badge layui-bg-green">增量</span>
  {{#  } }}
</script>


<script type="text/html" id="operateTpl">
				<a title="编辑" id="job_edit_btn" href="javascript:editJob({{d.id}});">
					<i class="layui-icon">&#xe642;</i>
				</a>
				<a title="删除" id="job_delete_btn_"   href="javascript:deleteOneJob({{d.id}});">
					<i class="layui-icon">&#xe640;</i>
				</a>
</script>

<div class="weadmin-nav">
	<span class="layui-breadcrumb">
        <a href="">首页</a>
        <a><cite>调度配置</cite></a>
    </span>
			<a class="layui-btn layui-btn-sm" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">
				<i class="layui-icon" style="line-height:30px">&#x1002;</i></a>
</div>

<div class="weadmin-body">
	<div class="layui-row">
		<div class="layui-inline">
			<label class="layui-form-label">作业名称:</label>
			<div class="layui-input-inline">
				<input type="text" id="job_name" name="jobName" placeholder="请输入关键字" autocomplete="off" class="layui-input"  onkeydown="if(event.keyCode==13) search()" >
			</div>
		</div>
         <div class="layui-inline">
           <button class="layui-btn layuiadmin-btn-list layui-btn-sm" id="job_search_btn" lay-submit=""  lay-filter="LAY-app-contlist-search">
             <i class="layui-icon layui-icon-search layuiadmin-button-btn" ></i>
           </button>
         </div>
         &nbsp;&nbsp;&nbsp;&nbsp;
         <div class="layui-inline"> <button title="添加配置 "  class="layui-btn layui-btn-sm" id="job_add_btn" onclick="addJob()" > <i class="layui-icon">&#xe654;</i> </button></div>
         <div class="layui-inline"><button title="批量删除 " class="layui-btn  layui-btn-danger  layui-btn-sm"><i class="layui-icon">&#xe640;</i> </button></div>
         <div class="layui-inline"><button title="手动执行" class="layui-btn  layui-btn-warm  layui-btn-sm" onclick="runJob()">Run</button></div>
         &nbsp;&nbsp;
         
          <div>
		    <table width="100%" id="jobManagerListTable" ></table>
	     </div>
	</div>
</div>

<script src="/static/layui/layui.js"></script>
<!-- <script src="/static/js/jquery.js"></script> -->
<script type="text/javascript">
layui.use(['element','form','table','layer','jquery'], function(){
	  var element = layui.element;
	  	  form = layui.form;
	  	  table = layui.table;
	  	  layer = layui.layer;
	  	  $=layui.jquery;
	  
	  table.render({
		  	id:"id_job",
		    elem: '#jobManagerListTable'
		    	,size:'sm'
		    ,url:'/taskCronJob/listAll'
		    ,cols: [[
			  {type:'checkbox'}
		      /* ,{field:'id', title: '序号',width:60,hide:true} */
		      ,{field:'jobName',width:130, title: '作业名称'}
		      ,{field:'dir',width:100, title: '程序路径'}
		      ,{field:'jobParams',width:60, title: '参数'}
		      ,{field:'jobClassName',width:90,  title: '任务类型',templet: function(d){
		         if(d.jobClassName == 'top.ruandb.Job.KettleJob'){
		        	 return "KettleJob"
		         }
		         if(d.jobClassName == 'top.ruandb.Job.TestJob'){
		        	 return "TestJob"
		         }
		         
		      }}
		      ,{field:'cron',width:100, title: '调度表达式'}
		      ,{field:'jobDescription', width:150,title: '作业说明'}
		      ,{field:'extractStyle', width:70,title: '方式',align:'center',templet:styleSwitchTpl}
		      ,{field:'increaseTime', width:110,title: '增量时间点',align:'center'}
		      ,{field:'enabled', title: '是否启用',width:80,align:'center',templet:enabledSwitchTpl}
		      ,{field:'', title: '操作',width:80,align:'center',templet:operateTpl}
		    ]]
		    ,page: true
		  });
	  
	// 
	    form.on('checkbox(enabledSwitch)', function(obj){
	    	/* $.post("/admin/user/updateVipState",{"id":this.name,"vip":obj.elem.checked},function(result){
				if(result.success){
					layer.msg("执行成功！");
					table.reload("userListTable",{});
				}else{
					layer.msg("执行失败，请联系管理员！");
				}
			},"json"); */
	    	//console.log(this);
	      
	    });
	  
	  //查询
	  $(document).on('click','#job_search_btn',function(){
		  var jobName=$("#job_name").val();
			table.reload("id_job",{
				page:{
					curr:1
				}
				,where:{
					jobName:jobName
				}
			});
		 });
	/*   
	  //添加任务
	  $(document).on('click','#job_add_btn',function(){
		  layer.open({
			  type: 2,
			  title: '添加任务',
			  area: ['700px', '400px'],
		  	  content:'/admin/saveJob.html'
		  });
		 }); */
		
	  });
	  
 //添加任务  
 function addJob(){
	 layer.open({
		  type: 2,
		  title: '添加任务',
		  area: ['700px', '420px'],
	  	  content:'/admin/saveJob.html', skin:'layui-layer-molv'
	  	 
	  	  
	  });
 }	  
	
 //删除单个Job
 function deleteOneJob(id){
	 layer.confirm('您确定要删除这条记录吗？',{
		 skin: 'layui-layer-molv'
		,title:"系统提示"
	    ,btn: ['确定','取消'] //按钮
	 },function(){
		 layer.closeAll('dialog');
		 $.post("/taskCronJob/deleteOneJob",{"id":id},function(result){
			 if(result.success){
					layer.msg("删除成功！");
					table.reload("id_job",{});
				}else{
					layer.msg("删除失败，请联系管理员！");
				}
		 },"json");
	 });
 }
 
 //编译Job
 function editJob(id){
	 layer.open({
		  type: 2,
		  title: '修改任务',
		  area: ['700px', '420px'],
	  	  content:'/admin/saveJob.html?id='+id, skin:'layui-layer-molv'
	  });
 }	
 
function runJob(){
	var checkStatus = table.checkStatus('id_job');
	//console.log(checkStatus.data.length)
	
	if(checkStatus.data.length == 0){
		layer.alert('请选择一条执行任务',{skin:'layui-layer-molv',closeBtn:0});
		return 
	}
	
	if(checkStatus.data.length > 1){
		layer.alert('请选择一条执行任务',{skin:'layui-layer-molv',closeBtn:0});
		return 
	}
	 layer.confirm('您确定要运行'+checkStatus.data[0].jobName+'嘛？',{
		 skin: 'layui-layer-molv'
		,title:"系统提示"
	    ,btn: ['确定','取消'] //按钮
	 },function(){
		 layer.closeAll('dialog');
		 $.post('/taskCronJob/runJob',checkStatus.data[0],function(result){
				if(result.success){
					layer.alert(checkStatus.data[0].jobName+'已经启动，请查看调度监控查看该任务运行情况。',{skin:'layui-layer-molv',closeBtn:0});
				}else{
					layer.alert(checkStatus.data[0].jobName+'执行异常，请联系管理员',{skin:'layui-layer-molv',closeBtn:0});
				}
			},'json');
	 });
	
	

};



</script> 
</body>
</html>
